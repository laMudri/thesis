This section is a development of the work of \citet{WA20}.

Let us write $\sdtstile{}\V$ as the infix version of $\V$.
That is, $\Gamma \sdtstile{}\V A \coloneqq \V\,\Gamma\,A$.
In this section, we introduce \emph{$\V$-environments}, which will form a key
part of the generic traversal of \cref{sec:semantics}.
The idea of a $\V$-environment is to extend the notion of $\V$-values from
types to contexts.
Specifically, where the judgement $\Gamma \sdtstile{}\V A$ says that we
have a $\V$-value of type $A$ in context $\Gamma$, the judgement
$\Gamma \env\V \Delta$ says that we have a $\V$-value for each entry in
$\Delta$ (at the specified multiplicity), all in context $\Gamma$.
For our purposes, it is essential that the ``all'' in the previous sentence is
multiplicative --- we want to split the usage annotations of $\Gamma$ up into
parts such that each part supports one $\V$-value.

We have seen two kinds of values already: $\sqni$-values are variables and
$\vdash$-values are terms.
The corresponding environments are also standard concepts: $\sqni$-environments
are \emph{simultaneous renamings} and $\vdash$-environments are
\emph{simultaneous substitutions}.

\subsection{Definition}

\begin{definition}\label{def:lr-env}
  A \emph{$\V$-environment} between annotated contexts $\Gamma$ and $\Delta$
  (written $\grP\gamma$ and $\grQ\delta$, respectively, when convenient)
  is a linear map $\gr\Psi : \Ann^{\size\Delta} \to \Ann^{\size\Gamma}$ (written
  postfix) such that $\grP \leq \grQ\gr\Psi$ and for each $A$, $\grPprime$, and
  $\grQprime$ such that $\grPprime \leq \grQprime\gr\Psi$, a function from
  $\grQprime\delta \sqni A$ to $\grPprime\gamma \sdtstile{}\V A$.
\end{definition}

\begin{example}
  We can form the identity renaming on a two-variable context.
  \[
    \id : \plr{\gr rA, \gr sB} \env\sqni \plr{\gr rA, \gr sB}
  \]
  Linear map $\gr\Psi$ is the identity map, clearly satisfying
  \(
    \begin{pmatrix} \gr r & \gr s \end{pmatrix} \leq
    \begin{pmatrix} \gr r & \gr s \end{pmatrix}\gr\Psi
  \).
  When considering values, the fact that $\grPprime \leq \grQprime\gr\Psi$
  reduces to $\grPprime \leq \grQprime$.
  The two cases to consider are when $\grQprime\delta \sqni A$ and when
  $\grQprime\delta \sqni B$.
  In the first case, $\grPprime \leq \grQprime \leq
  \begin{pmatrix} \gr1 & \gr0 \end{pmatrix}$, so we have
  $\grPprime\plr{A, B} \sqni A$.
  The second case follows symmetrically.
\end{example}

\begin{example}
  Assume $\Ann$ is the natural numbers with ordering given by $=$ and the usual
  addition and multiplication.
  There is an environment (substitution) of type
  \[
    \plr{\gr0x : A, \gr2y : B \multimap C, \gr3z : B} \env\vdash
    \plr{\gr1B, \gr2C}.
  \]
  Linear map $\gr\Psi$ is given by the matrix
  \(
    \begin{pmatrix}
      \gr0 & \gr0 & \gr1 \\
      \gr0 & \gr1 & \gr1
    \end{pmatrix}
  \),
  noticing that $\gr1$ times the first row plus $\gr2$ times the second gives
  the original $\grP$.
  For $\grQprime = \begin{pmatrix} \gr1 & \gr0 \end{pmatrix}$, we have
  $\grPprime = \begin{pmatrix} \gr0 & \gr0 & \gr1 \end{pmatrix}$, and thus
  $\grPprime\gamma \vdash z : B$.
  For $\grQprime = \begin{pmatrix} \gr0 & \gr1 \end{pmatrix}$, we have
  $\grPprime = \begin{pmatrix} \gr0 & \gr1 & \gr1 \end{pmatrix}$, and thus
  $\grPprime\gamma \vdash y\,z : C$.
\end{example}

As a mnemonic, one may use notation like the following to see what values are
needed in the environment.
\[
  \begin{pmatrix}
    \gr0A & \gr0\plr{B \multimap C} & \gr1B \\
    \gr0A & \gr1\plr{B \multimap C} & \gr1B
  \end{pmatrix}
  \begin{matrix}
    {} \vdash B \\
    {} \vdash C
  \end{matrix}
\]
This notation assumes that the notion of value supports subusaging, which is
always the case when we are using environments for traversals.

\begin{example}
  Assume $\Ann$ is the natural numbers with ordering given by $=$ and the usual
  addition and multiplication.
  There is an environment (renaming) of type
  \[
    \plr{\gr6a : A, \gr0b : B, \gr1c : C, \gr0d : D} \env\sqni
    \plr{\gr1C, \gr2A, \gr4A}.
  \]
  Linear map $\gr\Psi$ is given by the matrix
  \(
    \begin{pmatrix}
      \gr0 & \gr0 & \gr1 & \gr0 \\
      \gr1 & \gr0 & \gr0 & \gr0 \\
      \gr1 & \gr0 & \gr0 & \gr0
    \end{pmatrix}
  \),
  which we can check satisfies the required inequality.
  The values are given by
  \begin{align*}
    \gr0a : A, \gr0b : B, \gr1c : C, \gr0 : D &\sqni c : C \\
    \gr1a : A, \gr0b : B, \gr0c : C, \gr0 : D &\sqni a : A \\
    \gr1a : A, \gr0b : B, \gr0c : C, \gr0 : D &\sqni a : A.
  \end{align*}

  We can read from the columns of the matrix what happened to each of the
  variables in $\Gamma$.
  The first column, corresponding to variable $\gr6a : A$, contains two $\gr1$s
  because it has been duplicated (via contraction).
  Meanwhile, the second and fourth columns are all $\gr0$ because variables
  $b$ and $d$ have been discarded (via weakening).
  The third column contains one $\gr1$ because $c$ is used once.
  This $\gr1$ appears above the $\gr1$s to its left because $c$ has been
  permuted (via exchange) past $a$.
  Each of the rows in the matrix is a basis vector because variables can only
  be formed in contexts with basis annotations or less.
\end{example}

\subsection{Properties}

When constructing an environment, we can do so by cases on the shape of the
target context.
We can create an environment into the empty context when all usage annotations
on the source context are $\gr0$.
We can create an environment into a concatenated context when we can additively
split up the annotations of the source context and produce environments into
both halves from the split sources.
We can create an environment into a singleton context when there is a context
$\gr r$ times smaller than the source context in which we can produce a value
of the appropriate type.

\begin{lemma}\label{thm:env-rules}
  \Cref{def:lr-env} is sound and complete for the following syntax.
  \begin{displaymath}
    \begin{prooftree}[comb,center=false]
      \hypo{I^*}
      \infer1{\alr{} : {} \env\V {\cdot}}
    \end{prooftree}
    \qquad
    \begin{prooftree}[comb,center=false]
      \hypo{\rho : {} \env\V \Delta_l}
      \hypo{\sep}
      \hypo{\sigma : {} \env\V \Delta_r}
      \infer3{\alr{\rho,\sigma} : {} \env\V \Delta_l, \Delta_r}
    \end{prooftree}
    \qquad
    \begin{prooftree}[comb,center=false]
      \hypo{\gr r\cdot\plr{M : {} \sdtstile{}\V A}}
      \infer1{\alr{M} : {} \env\V \gr rA}
    \end{prooftree}
  \end{displaymath}
\end{lemma}

\begin{example}
  Assume $\Ann$ is the natural numbers with ordering given by $=$ and the usual
  addition and multiplication.
  There is an environment (substitution) of type
  \[
    \alr{\alr{z},\alr{y\,z}} :
    \plr{\gr0x : A, \gr2y : B \multimap C, \gr3z : B} \env\vdash
    \plr{\gr1B, \gr2C}.
  \]
  We rely on the observations that
  $\begin{pmatrix} \gr0 & \gr2 & \gr3 \end{pmatrix} =
  \begin{pmatrix} \gr0 & \gr0 & \gr1 \end{pmatrix}
  + \begin{pmatrix} \gr0 & \gr2 & \gr2 \end{pmatrix}$ and, on the right, that
  $\begin{pmatrix} \gr0 & \gr2 & \gr2 \end{pmatrix} =
  \gr2\begin{pmatrix} \gr0 & \gr1 & \gr1 \end{pmatrix}$.
  Then, we have $\gr0x : A, \gr0y : B \multimap C, \gr1z : B \vdash z : B$ and
  $\gr0x : A, \gr1y : B \multimap C, \gr1z : B \vdash y\,z : C$.
\end{example}

We could, indeed, use this syntax to define what an environment is.
However, we find them difficult to work with, as it is often easier to do
linear algebraic proofs separately from the rest of an environment.
For example, for identity and composition of environments, the original
definition
is easier to use because we can rely on the identity and composition of linear
maps.
Concretely, an inductive proof of identity would, for example, involve
constructing an environment of type
$\grP\gamma, \grQ\delta \env\V \grP\gamma, \grQ\delta$ by constructing
environments of types $\grP\gamma, \gr0\delta \env\V \grP\gamma$ and
$\gr0\gamma, \grQ\delta \env\V \grQ\delta$.
These are not identity environments, so we would have to strengthen the
induction hypothesis.

\begin{lemma}[\AgdaFunction{relocate}]\label{thm:env-resize}
  Given an environment $\rho : \grP\gamma \env\V \grQ\delta$ and a $\grPprime$
  and a $\grQprime$ such that $\grPprime \leq \grQprime\plr{\rho.\gr\Psi}$,
  there is also an environment of type $\grPprime\gamma \env\V \grQprime\delta$
  with the same linear map and action on variables.
\end{lemma}
\begin{proof}
  The only part of the definition of an environment dependent on $\grP$ or
  $\grQ$ is the constraint $\grP \leq \grQ\gr\Psi$, which we are able to
  replace for $\grPprime$ and $\grQprime$.
\end{proof}

One of the primary test cases for environments is simultaneous substitution,
which will look like the following rule.
The admissibility of substitution will be by induction on the derivation of
$\Delta \vdash A$, so we will need to be able to adapt any environment we are
given to work with any possible context of new premises.
In the simply typed case, the only change to the context we encountered was the
binding of new variables.
Now, with usage annotations, we furthermore have linear decompositions of the
context, necessitating changes to the environment whenever usage annotations
change.
We deal first with linear decompositions.

\begin{displaymath}
  \begin{prooftree}
    \hypo{\Gamma \env{\vdash} \Delta}
    \hypo{\Delta \vdash A}
    \infer2[sub]{\Gamma \vdash A}
  \end{prooftree}
\end{displaymath}

There are three kinds of linear decompositions we have to deal with: zero,
addition, and scaling; corresponding to bunched connectives $I^*$, $\sep$, and
$\gr r \cdot {}$, respectively.
In each case, we have a simple preservation lemma, transforming an environment
of type $\Gamma \env\V \Delta$ and a decomposition of $\Delta$ into a
decomposition of $\Gamma$ and environments for all of the decomposed fragments
of $\Gamma$ and $\Delta$.

\begin{lemma}[environments preserve zero]\label{thm:lr-env-zero}
  Given an environment of type $\grP\gamma \env\V \grQ\delta$ such that
  $\grQ \leq \gr 0$, we also have that $\grP \leq \gr 0$.
\end{lemma}

\begin{lemma}[environments preserve addition]\label{thm:lr-env-add}
  Given an environment of type $\grP\gamma \env\V \grQ\delta$ such that
  $\grQ \leq \grQl + \grQr$ for some $\grQl$ and $\grQr$, we also have $\grPl$
  and $\grPr$ such that $\grP \leq \grPl + \grPr$ and there are environments
  of types $\grPl\gamma \env\V \grQl\delta$ and
  $\grPr\gamma \env\V \grQr\delta$.
\end{lemma}

\begin{lemma}[environments preserve scaling]\label{thm:lr-env-scale}
  Given an environment of type $\grP\gamma \env\V \grQ\delta$ such that
  $\grQ \leq \gr r\grQprime$ for some $\grQprime$, we also have a $\grPprime$
  such that $\grP \leq \gr r\grPprime$ and there is an environment of type
  $\grPprime\gamma \env\V \grQprime\delta$.
\end{lemma}

Finally, we also take the opportunity to give the extend lemma, allowing
environments to incorporate newly bound variables.
\todo{Motivate}
In the intuitionistic case, the extend lemma had two requirements on $\V$: $\V$
admits weakening and we can map variables into $\V$-values.
With usage annotations, the former is unreasonable, but it turns out that we
only need weakening by variables whose usage annotation is less than or equal
to $\gr0$.
The latter stays as-is, with the note that ``variable'' now means a
usage-checked variable.

\begin{lemma}[extend]\label{thm:lr-bind}
  Given functions
  ${\swarrow^k} : \forall \Gamma, \grR, \theta.~\grR \leq \gr0 \to
  \forallb{\V\,\Gamma \dotto \V\,\plr{\Gamma, \grR\theta}}$ and
  $\mathrm{vr} : \forallb{{\sqni} \dotto \V}$, we can turn an environment of
  type $\Gamma \env\V \Delta$ into an environment of type
  $\Gamma, \Theta \env\V \Delta, \Theta$ for any context $\Theta$.
\end{lemma}

\subsection{Identity and composition}

The requirements for identity and composition of environments look a bit like
the unit and lift of a Kleisli triple.

\begin{lemma}[Identity environment]\label{thm:env-id}
  Given a function $\mathrm{vr} : \forallb{{\sqni} \dotto \V}$, for any
  $\Gamma$ we have an environment of type $\Gamma \env\V \Gamma$.
\end{lemma}

\begin{lemma}[Composition of environments]\label{thm:env-comp}
  Given a function
  $\mathrm{lift} : \plr{\rho : \grP\gamma \env\U \grQ\delta} \to
  \forall \grPprime, \grQprime.~\grPprime \leq \grQprime\plr{\rho.\gr\Psi} \to
  \forallb{\V\,\grQprime\delta \dotto \W\,\grPprime\gamma}$, then we can
  compose environments of types $\Gamma \env\U \Delta$ and
  $\Delta \env\V \Theta$ into an environment of type $\Gamma \env\W \Theta$.
\end{lemma}

\begin{corollary}\label{thm:env-postren}
  Given an environment $\rho : \Gamma \env\U \Delta$ and a renaming
  $\sigma : \Delta \env\sqni \Theta$, we can get an environment of type
  $\Gamma \env\U \Theta$.
  When $\U = {\sqni}$, this gives composition of renamings.
\end{corollary}
\begin{proof}
  By \cref{thm:env-comp}, with $\mathrm{lift}$ being given exactly by the
  action of $\rho$ on variables.
\end{proof}

\begin{example}
  We can derive the following instances of environment composition.
  \begin{itemize}
    \item If $\V = \W = {\vdash}$, then $\mathrm{lift}$ is given by a
      syntactic traversal.
      For example, if $\U = {\sqni}$, we need the action of renaming on terms
      to show that a renaming followed by a substitution composes to a
      substitution.
      If $\U = {\vdash}$, then the action of substitution on terms gives us that
      substitutions compose.
    \item More generally, if $\V = {\vdash}$ and we have a semantics from
      $\U$ to $\W$, then $\mathrm{lift}$ can be given by the semantic traversal
      of terms.
      This shows that a substitution and a semantics can turn a
      $\U$-environment into a $\W$-environment.
  \end{itemize}
\end{example}
