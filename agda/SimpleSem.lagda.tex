\begin{code}
{-# OPTIONS --safe --without-K --postfix-projections #-}
module SimpleSem where

open import Data.LTree
open import Data.LTree.Vector
open import Data.Product
open import Function.Base using (id)
open import Relation.Binary.PropositionalEquality hiding ([_])

infix 4 _âˆ‹_ _âŠ¢_
infixr 5 _`â†’_
infix 5 _++á¶œ_

data Ty : Set where
  Î¹ : Ty
  _`â†’_ : (A B : Ty) â†’ Ty
\end{code}

%<*Ctx>
\begin{code}
record Ctx : Set where
  constructor ctx
  field
    {shape} : LTree
    ty-ctx : Vector Ty shape
open Ctx public
\end{code}
%</Ctx>

\begin{code}
[_]á¶œ : Ty â†’ Ctx
[ A ]á¶œ = ctx [ A ]
[]á¶œ : Ctx
[]á¶œ = ctx []
_++á¶œ_ : (Î“ Î” : Ctx) â†’ Ctx
ctx Î³ ++á¶œ ctx Î´ = ctx (Î³ ++ Î´)
\end{code}

%<*Var>
\begin{code}
record _âˆ‹_ (Î“ : Ctx) (A : Ty) : Set where
  constructor el
  field
    idx : Ptr (Î“ .shape)
    tyq : Î“ .ty-ctx idx â‰¡ A
open _âˆ‹_ public
\end{code}
%</Var>

\begin{code}
hereáµ› : âˆ€ {A} â†’ [ A ]á¶œ âˆ‹ A
hereáµ› = el here refl
â†™áµ› : âˆ€ {Î“ Î” A} â†’ Î“ âˆ‹ A â†’ Î“ ++á¶œ Î” âˆ‹ A
â†™áµ› (el i q) = el (â†™ i) q
â†˜áµ› : âˆ€ {Î“ Î” A} â†’ Î” âˆ‹ A â†’ Î“ ++á¶œ Î” âˆ‹ A
â†˜áµ› (el i q) = el (â†˜ i) q
\end{code}

%<*Term>
\begin{code}
data _âŠ¢_ (Î“ : Ctx) : Ty â†’ Set where
  var : âˆ€ {A} â†’ Î“ âˆ‹ A â†’ Î“ âŠ¢ A
  app : âˆ€ {A B} â†’ Î“ âŠ¢ A `â†’ B â†’ Î“ âŠ¢ A â†’ Î“ âŠ¢ B
  lam : âˆ€ {A B} â†’ Î“ ++á¶œ [ A ]á¶œ âŠ¢ B â†’ Î“ âŠ¢ A `â†’ B
\end{code}
%</Term>

\begin{code}
module Kits where
\end{code}

%<*Env>
\begin{code}
  Env : (K : Ctx â†’ Ty â†’ Set) (Î“ Î” : Ctx) â†’ Set
  Env K Î“ Î” = âˆ€ {A} â†’ Î” âˆ‹ A â†’ K Î“ A
\end{code}
%</Env>

%<*RenSub>
\begin{code}
  Ren = Env _âˆ‹_
  Sub = Env _âŠ¢_
\end{code}
%</RenSub>

\begin{code}
  â–¡ : (Ctx â†’ Set) â†’ (Ctx â†’ Set)
  â–¡ T Î“ = âˆ€ {Î“âº} â†’ Ren Î“âº Î“ â†’ T Î“âº

  â—‹ : (Ctx â†’ Set) â†’ (Ctx â†’ Set)
  â—‹ T Î“ = âˆ€ {Î”} â†’ T (Î“ ++á¶œ Î”)
\end{code}

%<*Kit>
\begin{code}
  record Semantics (ğ“¥ ğ“’ : Ctx â†’ Ty â†’ Set) : Set where
    constructor kit
    field
      â†™áµ : âˆ€ {Î“ Î” A} â†’ ğ“¥ Î“ A â†’ ğ“¥ (Î“ ++á¶œ Î”) A
      âŸ¦varâŸ§ : âˆ€ {Î“ A} â†’ ğ“¥ Î“ A â†’ ğ“’ Î“ A
      âŸ¦appâŸ§ : âˆ€ {Î“ A B} â†’ ğ“’ Î“ (A `â†’ B) â†’ ğ“’ Î“ A â†’ ğ“’ Î“ B
      âŸ¦lamâŸ§ : âˆ€ {Î“ A B} â†’ â—‹ (Î» Î“âº â†’ ğ“¥ Î“âº A â†’ ğ“’ Î“âº B) Î“ â†’ ğ“’ Î“ (A `â†’ B)
\end{code}
%</Kit>

N.B., without the â–¡, we can write \verb|sem| without \verb|bindEnv|.
\begin{code}
    bindEnv : âˆ€ {Î“ Î” Î“r Î”r} â†’
      Env ğ“¥ Î“ Î” â†’ Env ğ“¥ (Î“ ++á¶œ Î“r) Î”r â†’ Env ğ“¥ (Î“ ++á¶œ Î“r) (Î” ++á¶œ Î”r)
    bindEnv Ï Ïƒ (el (â†™ i) q) = â†™áµ (Ï (el i q))
    bindEnv Ï Ïƒ (el (â†˜ i) q) = Ïƒ (el i q)

    sem : âˆ€ {Î“ Î” A} â†’ Env ğ“¥ Î“ Î” â†’ Î” âŠ¢ A â†’ ğ“’ Î“ A
    sem Ï (var x) = âŸ¦varâŸ§ (Ï x)
    sem Ï (app M N) = âŸ¦appâŸ§ (sem Ï M) (sem Ï N)
    sem Ï (lam M) = âŸ¦lamâŸ§ (Î» v â†’ sem (bindEnv Ï (Î» { (el i refl) â†’ v })) M)

  module _ where
    open Semantics

    RenSem : Semantics _âˆ‹_ _âŠ¢_
    RenSem .â†™áµ = â†™áµ›
    RenSem .âŸ¦varâŸ§ = var
    RenSem .âŸ¦appâŸ§ = app
    RenSem .âŸ¦lamâŸ§ b = lam (b (â†˜áµ› hereáµ›))  -- (b â†™áµ› (â†˜áµ› hereáµ›))

    ren = sem RenSem

    -- SubSem : Semantics _âŠ¢_ _âŠ¢_
    -- SubSem .â†™áµ = {!!}
    -- SubSem .âŸ¦varâŸ§ = id
    -- SubSem .âŸ¦appâŸ§ = app
    -- SubSem .âŸ¦lamâŸ§ b = lam (b â†™áµ› (var (â†˜áµ› hereáµ›)))
\end{code}
