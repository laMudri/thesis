\begin{code}
{-# OPTIONS --safe --without-K --postfix-projections #-}
module SimpleSem where

open import Data.LTree
open import Data.LTree.Vector
open import Data.Nat.Base
open import Data.Product
open import Data.Unit
open import Function.Base using (id; _Ë¢_)
open import Relation.Binary.PropositionalEquality hiding ([_])
open import Relation.Nary

open import SimpleKits
open Kits hiding (ren; sub; Kit)
\end{code}

%<*EnvSyntax>
\begin{code}
infix 20 [_]_â‡’áµ‰_
[_]_â‡’áµ‰_ = Env
\end{code}
%</EnvSyntax>

\begin{code}
module Circle where
\end{code}

%<*Circle>
\begin{code}
  â—‹ : (Ctx â†’ Set) â†’ (Ctx â†’ Set)
  â—‹ T Î“ = âˆ€ {Î”} â†’ T (Î“ ++á¶œ Î”)
\end{code}
%</Circle>

\begin{code}
  module Explicit where

    record Semanticsâ€² (ğ“¥ ğ“’ : Ctx â†’ Ty â†’ Set) : Set where
      constructor kit
      field
        â†™áµ : âˆ€ {Î“ Î” A} â†’ ğ“¥ Î“ A â†’ ğ“¥ (Î“ ++á¶œ Î”) A
\end{code}
%<*semVarApp>
\begin{code}
        âŸ¦varâŸ§ : âˆ€ {Î“ A} â†’ ğ“¥ Î“ A â†’ ğ“’ Î“ A
        âŸ¦appâŸ§ : âˆ€ {Î“ A B} â†’ ğ“’ Î“ (A `â†’ B) â†’ ğ“’ Î“ A â†’ ğ“’ Î“ B
\end{code}
%</semVarApp>
\begin{code}
        âŸ¦lamâŸ§ : âˆ€ {Î“ A B} â†’
          (âˆ€ {Î”} â†’ ğ“¥ (Î“ ++á¶œ Î”) A â†’ ğ“’ (Î“ ++á¶œ Î”) B) â†’ ğ“’ Î“ (A `â†’ B)
\end{code}

%<*SemanticsExplicit>
\begin{code}
    record Semantics (ğ“¥ ğ“’ : Ctx â†’ Ty â†’ Set) : Set where
      constructor kit
      field
        â†™áµ : âˆ€ {Î“ Î” A} â†’ ğ“¥ Î“ A â†’ ğ“¥ (Î“ ++á¶œ Î”) A
        âŸ¦varâŸ§ : âˆ€ {Î“ A} â†’ ğ“¥ Î“ A â†’ ğ“’ Î“ A
        âŸ¦appâŸ§ : âˆ€ {Î“ A B} â†’ ğ“’ Î“ (A `â†’ B) â†’ ğ“’ Î“ A â†’ ğ“’ Î“ B
        âŸ¦lamâŸ§ : âˆ€ {Î“ A B} â†’
          (âˆ€ {Î”} â†’ ğ“¥ (Î“ ++á¶œ Î”) A â†’ ğ“’ (Î“ ++á¶œ Î”) B) â†’ ğ“’ Î“ (A `â†’ B)
\end{code}
%</SemanticsExplicit>

%<*SemanticsCircle>
\begin{code}
  record Semantics (ğ“¥ ğ“’ : Ctx â†’ Ty â†’ Set) : Set where
    constructor kit
    infix 20 _ğ“¥âŠ¨_ _ğ“’âŠ¨_; private _ğ“¥âŠ¨_ = ğ“¥; _ğ“’âŠ¨_ = ğ“’
    field
      â†™áµ : âˆ€ {A} â†’ âˆ€[ _ğ“¥âŠ¨ A â‡’ â—‹ (_ğ“¥âŠ¨ A) ]
      âŸ¦varâŸ§ : âˆ€ {A} â†’ âˆ€[ _ğ“¥âŠ¨ A â‡’ _ğ“’âŠ¨ A ]
      âŸ¦appâŸ§ : âˆ€ {A B} â†’ âˆ€[ _ğ“’âŠ¨ (A `â†’ B) â‡’ _ğ“’âŠ¨ A â‡’ _ğ“’âŠ¨ B ]
      âŸ¦lamâŸ§ : âˆ€ {A B} â†’ âˆ€[ â—‹ (_ğ“¥âŠ¨ A â‡’ _ğ“’âŠ¨ B) â‡’ _ğ“’âŠ¨ (A `â†’ B) ]
\end{code}
%</SemanticsCircle>

N.B., without the â—‹/â–¡, we can write \verb|sem| without \verb|bindEnv|.
It is useless, though.
\begin{code}
    bindEnv : âˆ€ {Î” Î”r} â†’
      âˆ€[ [ ğ“¥ ]_â‡’áµ‰ Î” â‡’ â—‹ ([ ğ“¥ ]_â‡’áµ‰ Î”r â‡’ [ ğ“¥ ]_â‡’áµ‰ (Î” ++á¶œ Î”r)) ]
    bindEnv Ï Ïƒ (el (â†™ i) q) = â†™áµ (Ï (el i q))
    bindEnv Ï Ïƒ (el (â†˜ i) q) = Ïƒ (el i q)
\end{code}

%<*semType>
\begin{code}
    sem : âˆ€ {Î“ Î” A} â†’ Env ğ“¥ Î“ Î” â†’ Î” âŠ¢ A â†’ ğ“’ Î“ A
\end{code}
%</semType>
\begin{code}
    sem Ï (var x) = âŸ¦varâŸ§ (Ï x)
    sem Ï (app M N) = âŸ¦appâŸ§ (sem Ï M) (sem Ï N)
    sem Ï (lam M) = âŸ¦lamâŸ§ (Î» v â†’ sem (bindEnv Ï (Î» { (el i refl) â†’ v })) M)

  module _ where
    open Semantics
\end{code}

%<*RenSemCircle>
\begin{code}
    RenSem : Semantics _âˆ‹_ _âŠ¢_
    RenSem .â†™áµ v = â†™áµ› v
    RenSem .âŸ¦varâŸ§ = var
    RenSem .âŸ¦appâŸ§ = app
    RenSem .âŸ¦lamâŸ§ b = lam (b (â†˜áµ› hereáµ›))

    ren = sem RenSem
\end{code}
%</RenSemCircle>

\begin{code}
    SubSem : Semantics _âŠ¢_ _âŠ¢_
    SubSem .â†™áµ M = ren â†™áµ› M
    SubSem .âŸ¦varâŸ§ = id
    SubSem .âŸ¦appâŸ§ = app
    SubSem .âŸ¦lamâŸ§ b = lam (b (var (â†˜áµ› hereáµ›)))

    sub = sem SubSem
\end{code}

%<*SetSemCircle>
\begin{code}
    âŸ¦_âŸ§Ty : Ty â†’ Set
    âŸ¦ Î¹ âŸ§Ty = â„•
    âŸ¦ A `â†’ B âŸ§Ty = âŸ¦ A âŸ§Ty â†’ âŸ¦ B âŸ§Ty
    âŸ¦_âŸ§Ctx : Ctx â†’ Set
    âŸ¦ Î“ âŸ§Ctx = Liftâ‚™ âŸ¦_âŸ§Ty (Î“ .ty-ctx)
    âŸ¦_âŠ¢_âŸ§ : Ctx â†’ Ty â†’ Set
    âŸ¦ Î“ âŠ¢ A âŸ§ = âŸ¦ Î“ âŸ§Ctx â†’ âŸ¦ A âŸ§Ty

    SetSem : Semantics _âˆ‹_ âŸ¦_âŠ¢_âŸ§
    SetSem .â†™áµ v = â†™áµ› v
    SetSem .âŸ¦varâŸ§ (el i refl) Î³ = Î³ .get i
    SetSem .âŸ¦appâŸ§ m n Î³ = (m Î³) (n Î³)
    SetSem .âŸ¦lamâŸ§ b Î³ x = b (â†˜áµ› hereáµ›) (Î³ ++â‚™ [ x ]â‚™)

    set : âˆ€ {Î“ A} â†’ Î“ âŠ¢ A â†’ âŸ¦ Î“ âŠ¢ A âŸ§
    set = sem SetSem id
\end{code}
%</SetSemCircle>

\begin{code}
    module _ {A B Î“} (
\end{code}
%<*bRenSemCircle>
\begin{code}[inline]
      b : â—‹ (_âˆ‹ A â‡’ _âŠ¢ B) Î“
\end{code}
%</bRenSemCircle>
\begin{code}
      ) (T0 :
\end{code}
%<*resRenSemCircle>
\begin{code}[inline]
      Î“ ++á¶œ [ A ]á¶œ âŠ¢ B
\end{code}
%</resRenSemCircle>
\begin{code}
      ) (
\end{code}
%<*mSetSemCircle>
\begin{code}[inline]
      m : âŸ¦ Î“ âŸ§Ctx â†’ (âŸ¦ A âŸ§Ty â†’ âŸ¦ B âŸ§Ty)
\end{code}
%</mSetSemCircle>
\begin{code}
      ) (
\end{code}
%<*nSetSemCircle>
\begin{code}[inline]
      n : âŸ¦ Î“ âŸ§Ctx â†’ âŸ¦ A âŸ§Ty
\end{code}
%</nSetSemCircle>
\begin{code}
      ) (
\end{code}
%<*gammaSetSemCircle>
\begin{code}[inline]
      Î³ : âŸ¦ Î“ âŸ§Ctx
\end{code}
%</gammaSetSemCircle>
\begin{code}
      ) (T1 :
\end{code}
%<*semGA>
\begin{code}[inline]
      âŸ¦ Î“ âŠ¢ A âŸ§
\end{code}
%</semGA>
\begin{code}
      ) where

module Box where
\end{code}

%<*Box>
\begin{code}
  â–¡ : (Ctx â†’ Set) â†’ (Ctx â†’ Set)
  â–¡ T Î“ = âˆ€ {Î“âº} â†’ Ren Î“âº Î“ â†’ T Î“âº
\end{code}
%</Box>

%<*Semantics>
\begin{code}
  record Semantics (ğ“¥ ğ“’ : Ctx â†’ Ty â†’ Set) : Set where
    infix 20 _ğ“¥âŠ¨_ _ğ“’âŠ¨_; private _ğ“¥âŠ¨_ = ğ“¥; _ğ“’âŠ¨_ = ğ“’
    field
      ren^ğ“¥ : âˆ€ {A} â†’ âˆ€[ _ğ“¥âŠ¨ A â‡’ â–¡ (_ğ“¥âŠ¨ A) ]
      âŸ¦varâŸ§ : âˆ€ {A} â†’ âˆ€[ _ğ“¥âŠ¨ A â‡’ _ğ“’âŠ¨ A ]
      âŸ¦appâŸ§ : âˆ€ {A B} â†’ âˆ€[ _ğ“’âŠ¨ (A `â†’ B) â‡’ _ğ“’âŠ¨ A â‡’ _ğ“’âŠ¨ B ]
      âŸ¦lamâŸ§ : âˆ€ {A B} â†’ âˆ€[ â–¡ (_ğ“¥âŠ¨ A â‡’ _ğ“’âŠ¨ B) â‡’ _ğ“’âŠ¨ (A `â†’ B) ]
\end{code}
%</Semantics>

%<*bindEnv>
\begin{code}
    bindEnv : âˆ€ {Î” Î”r} â†’
      âˆ€[ [ ğ“¥ ]_â‡’áµ‰ Î” â‡’ â–¡ ([ ğ“¥ ]_â‡’áµ‰ Î”r â‡’ [ ğ“¥ ]_â‡’áµ‰ (Î” ++á¶œ Î”r)) ]
    bindEnv Ï r Ïƒ (el (â†™ i) q) = ren^ğ“¥ (Ï (el i q)) r
    bindEnv Ï r Ïƒ (el (â†˜ i) q) = Ïƒ (el i q)
\end{code}
%</bindEnv>

%<*sem>
\begin{code}
    sem : âˆ€ {Î“ Î” A} â†’ Env ğ“¥ Î“ Î” â†’ Î” âŠ¢ A â†’ Î“ ğ“’âŠ¨ A
    sem Ï (var x) = âŸ¦varâŸ§ (Ï x)
    sem Ï (app M N) = âŸ¦appâŸ§ (sem Ï M) (sem Ï N)
    sem Ï (lam M) = âŸ¦lamâŸ§ Î» r v â†’
      sem (bindEnv Ï r (Î» { (el i refl) â†’ v })) M
\end{code}
%</sem>

\begin{code}
  module _ where
    open Semantics
\end{code}

%<*ren>
\begin{code}
    RenSem : Semantics _âˆ‹_ _âŠ¢_
    RenSem .ren^ğ“¥ v r = r v
    RenSem .âŸ¦varâŸ§ = var
    RenSem .âŸ¦appâŸ§ = app
    RenSem .âŸ¦lamâŸ§ b = lam (b â†™áµ› (â†˜áµ› hereáµ›))

    ren = sem RenSem
\end{code}
%</ren>

%<*sub>
\begin{code}
    SubSem : Semantics _âŠ¢_ _âŠ¢_
    SubSem .ren^ğ“¥ M r = ren r M
    SubSem .âŸ¦varâŸ§ = id
    SubSem .âŸ¦appâŸ§ = app
    SubSem .âŸ¦lamâŸ§ b = lam (b â†™áµ› (var (â†˜áµ› hereáµ›)))

    sub = sem SubSem
\end{code}
%</sub>

%<*Kit>
\begin{code}
    record Kit (ğ“¥ : Ctx â†’ Ty â†’ Set) : Set where
      constructor kit
      infix 20 _ğ“¥âŠ¨_; private _ğ“¥âŠ¨_ = ğ“¥
      field
        ren^ğ“¥ : âˆ€ {A} â†’ âˆ€[ _ğ“¥âŠ¨ A â‡’ â–¡ (_ğ“¥âŠ¨ A) ]
        vr : âˆ€ {A} â†’ âˆ€[ _âˆ‹ A â‡’ _ğ“¥âŠ¨ A ]
        tm : âˆ€ {A} â†’ âˆ€[ _ğ“¥âŠ¨ A â‡’ _âŠ¢ A ]
    open Kit
\end{code}
%</Kit>

%<*kit>
\begin{code}
    kitâ†’sem : âˆ€ {ğ“¥} â†’ Kit ğ“¥ â†’ Semantics ğ“¥ _âŠ¢_
    kitâ†’sem K .ren^ğ“¥ = K .ren^ğ“¥
    kitâ†’sem K .âŸ¦varâŸ§ = K .tm
    kitâ†’sem K .âŸ¦appâŸ§ = app
    kitâ†’sem K .âŸ¦lamâŸ§ b = lam (b â†™áµ› (K .vr (â†˜áµ› hereáµ›)))
\end{code}
%</kit>
