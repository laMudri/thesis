\begin{code}
{-# OPTIONS --safe --without-K --postfix-projections --prop #-}
open import Algebra.Po
open import Level

module LRKits (poSemiring : PoSemiring 0â„“ 0â„“ 0â„“) where

  open PoSemiring poSemiring renaming (Carrier to Ann)

  open import Algebra.Relational renaming (_â†˜_â†™_ to _â†˜-_-â†™_)
  open import Data.LTree
  open import Data.LTree.Vector
  open import Data.Product
  open import Data.Wrap
  open import Function using (id; _âˆ˜_; Equivalence)
  open import Relation.Binary.PropositionalEquality as â‰¡ using (_â‰¡_)
  open import Relation.Nary
  open import Relation.Unary.Bunched

  data Ty : Set where
    Î¹ : Ty
    `! : (r : Ann) (A : Ty) â†’ Ty

  open import Generic.Linear.Operations rawPoSemiring
  open import Generic.Linear.Algebra poSemiring
  open import Generic.Linear.Syntax Ty Ann
  open import Generic.Linear.Syntax.Interpretation Ty rawPoSemiring
  open import Generic.Linear.Variable Ty rawPoSemiring
  open import Generic.Linear.Environment Ty poSemiring
  open import Generic.Linear.Environment.Properties Ty poSemiring
  open import Generic.Linear.Environment.Categorical Ty poSemiring
\end{code}

%<*Tm>
\begin{code}
  Bind : Ctx â†’ (Ctx â†’ Set) â†’ (Ctx â†’ Set)
  Bind Î” T Î“ = T (Î“ ++á¶œ Î”)

  data _âŠ¢_ : Ctx â†’ Ty â†’ Set where
    var : âˆ€[ _âˆ‹_ â‡’ _âŠ¢_ ]
    !-I : âˆ€ {r A} â†’ âˆ€[ r Â·á¶œ (_âŠ¢ A) â‡’ _âŠ¢ `! r A ]
    !-E : âˆ€ {r A C} â†’ âˆ€[ (_âŠ¢ `! r A) âœ´á¶œ Bind [ r Â· A ]á¶œ (_âŠ¢ C) â‡’ _âŠ¢ C ]
\end{code}
%</Tm>

\begin{code}
  module _ {ğ“¥ : Ctx â†’ Ty â†’ Set} where

    env-+ : âˆ€ {s t Î³ Î´ P Qâ‚— Qáµ£} â†’
      let Î“ = ctx {s} P Î³; Î”â‚— = ctx {t} Qâ‚— Î´; Î”áµ£ = ctx {t} Qáµ£ Î´ in
      (Î» Q â†’ [ ğ“¥ ] Î“ â‡’áµ‰ ctx Q Î´) â—‡ _â‰¤[ Qâ‚— +* Qáµ£ ] â†’
      (Î» Pâ‚— â†’ [ ğ“¥ ] ctx Pâ‚— Î³ â‡’áµ‰ Î”â‚—)
        â†˜- P â‰¤[_+*_] -â†™
      (Î» Páµ£ â†’ [ ğ“¥ ] ctx Páµ£ Î³ â‡’áµ‰ Î”áµ£)
    env-+ (Ï , sp) =
      let sumsâ‚— â†˜, spâ€² ,â†™ sumsáµ£ = Ï .asLinRel .linRel .rel-+â‚˜ (sp , Ï .sums) in
      record { [_]_â‡’áµ‰_ Ï; sums = sumsâ‚— }
        â†˜, spâ€² ,â†™
      record { [_]_â‡’áµ‰_ Ï; sums = sumsáµ£ }

    env-* : âˆ€ {s t Î³ Î´ P Qâ€² r} â†’
      let Î“ = ctx {s} P Î³; Î”â€² = ctx {t} Qâ€² Î´ in
      (Î» Q â†’ [ ğ“¥ ] Î“ â‡’áµ‰ ctx Q Î´) â—‡ _â‰¤[ r *â‚— Qâ€² ] â†’
      P â‰¤[ r *â‚—_] â—‡ (Î» Pâ€² â†’ [ ğ“¥ ] ctx Pâ€² Î³ â‡’áµ‰ Î”â€²)
    env-* (Ï , sp) =
      let spâ€² , sumsâ€² = Ï .asLinRel .linRel .rel-*â‚˜ (sp , Ï .sums) in
      spâ€² , record { [_]_â‡’áµ‰_ Ï; sums = sumsâ€² }
\end{code}

%<*Kit>
\begin{code}
  Weakening : âˆ€ {v} {A : Set} â†’ (Ctx â†’ A â†’ Set v) â†’ Set v
  Weakening ğ“¥ =
    âˆ€ {s t P} {Î³ : Vector Ty (s <+> t)} â†’ P âˆ˜ â†˜ â‰¤* 0* â†’
    âˆ€[ ğ“¥ (ctx (P âˆ˜ â†™) (Î³ âˆ˜ â†™)) â‡’ ğ“¥ (ctx P Î³) ]

  record Kit (ğ“¥ : Ctx â†’ Ty â†’ Set) : Set where
    constructor kit
    field
      â†™áµ : Weakening ğ“¥
      vr : âˆ€[ _âˆ‹_ â‡’ ğ“¥ ]
      tm : âˆ€[ ğ“¥ â‡’ _âŠ¢_ ]
\end{code}
%</Kit>

\begin{code}
    open Equivalence
\end{code}

%<*bindEnv>
\begin{code}
    bindEnv : âˆ€ {Î“ Î” Î˜} â†’ [ ğ“¥ ] Î“ â‡’áµ‰ Î” â†’ [ ğ“¥ ] Î“ ++á¶œ Î˜ â‡’áµ‰ Î” ++á¶œ Î˜
    bindEnv Ï .M = [ [ Ï .M â”‚ 0á´¹ ] â”€ [ 0á´¹ â”‚ 1á´¹ ] ]
    bindEnv Ï .asLinRel = Ï .asLinRel âŠ•AsLinRel idAsLinRel
    bindEnv Ï .sums = Ï .sums , â‰¤*-refl
    bindEnv Ï .lookup (ll , rr) (lvar (â†™ i) q b) =
      let bl , br = un++â‚™ b in
      â†™áµ (â‰¤*-trans rr br) (Ï .lookup ll (lvar i q bl))
    bindEnv Ï .lookup (ll , rr) (lvar (â†˜ i) q b) =
      let bl , br = un++â‚™ b in
      let blâ€² = 0*â†’â‰¤* (Ï .asLinRel .linRel .rel-0â‚˜ (â‰¤*â†’0* bl , ll)) in
      vr (lvar (â†˜ i) q (blâ€² ++â‚™ â‰¤*-trans rr br))
\end{code}
%</bindEnv>

%<*trav>
\begin{code}
    trav : âˆ€ {Î“ Î” A} â†’ [ ğ“¥ ] Î“ â‡’áµ‰ Î” â†’ Î” âŠ¢ A â†’ Î“ âŠ¢ A
    trav Ï (var x) = tm (Ï .lookup (Ï .sums) x)
    trav Ï (!-I (âŸ¨ sp* âŸ©Â· M)) =
      let sp*â€² , Ïâ€² = env-* (Ï , sp*) in
      !-I (âŸ¨ sp*â€² âŸ©Â· (trav Ïâ€² M))
    trav Ï (!-E (M âœ´âŸ¨ sp+ âŸ© N)) =
      let Ïâ‚— â†˜, sp+â€² ,â†™ Ïáµ£ = env-+ (Ï , sp+) in
      !-E (trav Ïâ‚— M âœ´âŸ¨ sp+â€² âŸ© trav (bindEnv Ïáµ£) N)
\end{code}
%</trav>

%<*dlv>
\begin{code}
  â†™áµ› : Weakening _âˆ‹_
  â†™áµ› Q0 v .idx = â†™ (v .idx)
  â†™áµ› Q0 v .tyq = v .tyq
  â†™áµ› Q0 v .basis = v .basis ++â‚™ Q0
\end{code}
%</dlv>

\begin{code}
  open Kit
\end{code}

%<*var-kit>
\begin{code}
  âˆ‹-kit : Kit _âˆ‹_
  âˆ‹-kit = kit â†™áµ› id var

  ren = trav âˆ‹-kit
\end{code}
%</var-kit>

\begin{code}
  instance
    identityEnv-âŠ¢ : IdentityEnv _âŠ¢_
    identityEnv-âŠ¢ .pure = var
\end{code}

%<*dlv-env>
\begin{code}
  â†™^Env : {ğ“¥ : Ctx â†’ Ty â†’ Set} â†’ Weakening ğ“¥ â†’ Weakening [ ğ“¥ ]_â‡’áµ‰_
  â†™^Env â†™^ğ“¥ Q0 Ï .M = [ Ï .M â”‚ 0á´¹ ]
  â†™^Env â†™^ğ“¥ Q0 Ï .asLinRel = [ Ï .asLinRel â”‚ 0AsLinRel ]AsLinRel
  â†™^Env â†™^ğ“¥ Q0 Ï .sums = Ï .sums , â‰¤*â†’0* Q0
  â†™^Env â†™^ğ“¥ Q0 Ï .lookup (r , sp0) v = â†™^ğ“¥ (0*â†’â‰¤* sp0) (Ï .lookup r v)

  â†™áµ›-env :
    âˆ€ {s t P} {Î³ : Vector Ty (s <+> t)} â†’ P âˆ˜ â†˜ â‰¤* 0* â†’
    [ _âˆ‹_ ] ctx P Î³ â‡’áµ‰ ctx (P âˆ˜ â†™) (Î³ âˆ˜ â†™)
  â†™áµ›-env Q0 = â†™^Env â†™áµ› Q0 id^Env
\end{code}
%</dlv-env>

%<*sub>
\begin{code}
  âŠ¢-kit : Kit _âŠ¢_
  âŠ¢-kit = kit (Î» Q0 â†’ ren (â†™áµ›-env Q0)) var id

  sub = trav âŠ¢-kit
\end{code}
%</sub>

\begin{code}
  idË¢ : âˆ€ {Î“} â†’ [ _âŠ¢_ ] Î“ â‡’áµ‰ Î“
  idË¢ = id^Env

  psh-âŠ¢ : IsPresheaf _âŠ¢_
  psh-âŠ¢ QP = ren (subuse^Env QP)

  mutual
    open With-psh^ğ“¥ psh-âŠ¢
\end{code}

%<*subSingle>
\begin{code}
    sub[-] : âˆ€ {s P Q R Î³ r A B} â†’ R â‰¤[ Q +*_] â—‡ _â‰¤[ r *â‚— P ] â†’
      ctx {s} P Î³ âŠ¢ A â†’ ctx Q Î³ ++á¶œ [ r Â· A ]á¶œ âŠ¢ B â†’ ctx R Î³ âŠ¢ B
    sub[-] {Q = Q} {R} {Î³} {r} {A} (sp+ , sp*) t = sub Ïƒ
      where
      Ïƒ : [ _âŠ¢_ ] ctx R Î³ â‡’áµ‰ ctx Q Î³ ++á¶œ [ r Â· A ]á¶œ
      Ïƒ = ++áµ‰ (idË¢ âœ´âŸ¨ sp+ âŸ© [-]áµ‰ (âŸ¨ sp* âŸ©Â· t))
\end{code}
%</subSingle>
