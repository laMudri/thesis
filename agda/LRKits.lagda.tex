\begin{code}
{-# OPTIONS --safe --without-K --postfix-projections --prop #-}
open import Algebra.Po
open import Level

module LRKits (poSemiring : PoSemiring 0â„“ 0â„“ 0â„“) where

  open PoSemiring poSemiring renaming (Carrier to Ann)

  open import Algebra.Relational renaming (_â†˜_â†™_ to _â†˜-_-â†™_)
  open import Data.LTree
  open import Data.LTree.Vector
  open import Data.Product
  open import Data.Wrap
  open import Function using (id; _âˆ˜_; Equivalence)
  open import Relation.Binary.PropositionalEquality as â‰¡ using (_â‰¡_)
  open import Relation.Nary.Extra using (_âŠ†_)
  open import Relation.Unary.Bunched

  data Ty : Set where
    Î¹ : Ty
    `! : (r : Ann) (A : Ty) â†’ Ty

  open import Generic.Linear.Operations rawPoSemiring
  open import Generic.Linear.Algebra poSemiring
  open import Generic.Linear.Syntax Ty Ann
  open import Generic.Linear.Syntax.Interpretation Ty rawPoSemiring hiding (â—‡)
  open import Generic.Linear.Variable Ty rawPoSemiring hiding (_â†™áµ›_; _â†˜áµ›_)
  open import Generic.Linear.Environment Ty poSemiring
  open import Generic.Linear.Environment.Properties Ty poSemiring
  open import Generic.Linear.Environment.Categorical Ty poSemiring
\end{code}

%<*Tm>
\begin{code}
  Bind : Ctx â†’ (Ctx â†’ Set) â†’ (Ctx â†’ Set)
  Bind Î” T Î“ = T (Î“ ++á¶œ Î”)

  data _âŠ¢_ : Ctx â†’ Ty â†’ Set where
    var : _âˆ‹_ âŠ† _âŠ¢_
    !-I : âˆ€ {r A} â†’ r Â· (_âŠ¢ A) âŠ† _âŠ¢ `! r A
    !-E : âˆ€ {r A C} â†’ (_âŠ¢ `! r A) âœ´ Bind [ r âˆ™ A ]á¶œ (_âŠ¢ C) âŠ† _âŠ¢ C
\end{code}
%</Tm>

\begin{code}
  module _ {ğ“¥ : Ctx â†’ Ty â†’ Set} where

    env-+ : âˆ€ {s t Î³ Î´ P Qâ‚— Qáµ£} â†’
      let Î“ = ctx {s} P Î³; Î”â‚— = ctx {t} Qâ‚— Î´; Î”áµ£ = ctx {t} Qáµ£ Î´ in
      (Î» Q â†’ [ ğ“¥ ] Î“ â‡’áµ‰ ctx Q Î´) â—‡ (_â‰¤[ Qâ‚— +* Qáµ£ ]) â†’
      (Î» Pâ‚— â†’ [ ğ“¥ ] ctx Pâ‚— Î³ â‡’áµ‰ Î”â‚—)
        â†˜- P â‰¤[_+*_] -â†™
      (Î» Páµ£ â†’ [ ğ“¥ ] ctx Páµ£ Î³ â‡’áµ‰ Î”áµ£)
    env-+ (Ï , sp) =
      let fit-hereâ‚— â†˜, spâ€² ,â†™ fit-hereáµ£ = Ï .Î¨ .rel-+â‚˜ (Ï .fit-here , sp) in
      record { [_]_â‡’áµ‰_ Ï; fit-here = fit-hereâ‚— }
        â†˜, spâ€² ,â†™
      record { [_]_â‡’áµ‰_ Ï; fit-here = fit-hereáµ£ }

    env-* : âˆ€ {s t Î³ Î´ P Qâ€² r} â†’
      let Î“ = ctx {s} P Î³; Î”â€² = ctx {t} Qâ€² Î´ in
      (Î» Q â†’ [ ğ“¥ ] Î“ â‡’áµ‰ ctx Q Î´) â—‡ _â‰¤[ r *â‚— Qâ€² ] â†’
      P â‰¤[ r *â‚—_] â—‡ (Î» Pâ€² â†’ [ ğ“¥ ] ctx Pâ€² Î³ â‡’áµ‰ Î”â€²)
    env-* (Ï , sp) =
      let fit-hereâ€² , spâ€² = Ï .Î¨ .rel-*â‚˜ (Ï .fit-here , sp) in
      spâ€² , record { [_]_â‡’áµ‰_ Ï; fit-here = fit-hereâ€² }
\end{code}

%<*Weakening>
\begin{code}
  Weakening : âˆ€ {v} {A : Set} â†’ (Ctx â†’ A â†’ Set v) â†’ Set v
  Weakening ğ“¥ =
    âˆ€ {s t P} {Î³ : Vector Ty (s <+> t)} â†’ P âˆ˜ â†˜ â‰¤* 0* â†’
    ğ“¥ (ctx (P âˆ˜ â†™) (Î³ âˆ˜ â†™)) âŠ† ğ“¥ (ctx P Î³)
\end{code}
%</Weakening>

%<*Kit>
\begin{code}
  record Kit (ğ“¥ : Ctx â†’ Ty â†’ Set) : Set where
    constructor kit
    field
      â†™áµ : Weakening ğ“¥
      vr : _âˆ‹_ âŠ† ğ“¥
      tm : ğ“¥ âŠ† _âŠ¢_
\end{code}
%</Kit>

\begin{code}
    open Equivalence
    private module Vá¶ á´¿ {s} = FRelLeftSemimodule (Vá¶ á´¿ s)
    open Vá¶ á´¿
\end{code}

%<*bindEnv>
\begin{code}
    bindEnv : âˆ€ {Î“ Î” Î˜} â†’ [ ğ“¥ ] Î“ â‡’áµ‰ Î” â†’ [ ğ“¥ ] Î“ ++á¶œ Î˜ â‡’áµ‰ Î” ++á¶œ Î˜
\end{code}
%</bindEnv>
\begin{code}
    bindEnv Ï .Î¨ = [  [ Ï .Î¨  â”‚ 0á´¿ ]á´¿
                              â”€
                      [ 0á´¿    â”‚ 1á´¿ ]á´¿ ]á´¿
    bindEnv Ï .fit-here = _â†˜,_,â†™_
      {left = _ ++ _} {right = _ ++ _}
      (Ï .fit-here , 0*-triv)
      (+*-identityâ†˜ _ ++â‚™ +*-identityâ†™ _)
      (0*-triv , â‰¤*-refl)
    bindEnv Ï .lookup ((ul , ur) â†˜, sp+ ,â†™ (dl , dr)) (lvar i q b)
      with un++â‚™ sp+ | un++â‚™ b
    bindEnv Ï .lookup ((ul , ur) â†˜, sp+ ,â†™ (dl , dr)) (lvar (â†™ i) q b)
      | sp+l , sp+r | bl , br = â†™áµ
      (â‰¤*-trans (+â‚˜-identityË¡â†’ (ur , sp+r)) (â‰¤*-trans dr br))
      (Ï .lookup (Ï .Î¨ .rel-â‰¤â‚˜ (+â‚˜-identityÊ³â†’ (sp+l , dl)) â‰¤*-refl ul)
        (lvar i q bl))
    bindEnv Ï .lookup ((ul , ur) â†˜, sp+ ,â†™ (dl , dr)) (lvar (â†˜ i) q b)
      | sp+l , sp+r | bl , br = vr (lvar (â†˜ i) q
      (â‰¤*-trans (+â‚˜-identityÊ³â†’ (sp+l , dl))
        (0*â†’â‰¤* (Ï .Î¨ .rel-0â‚˜ (ul , â‰¤*â†’0* bl)))
      ++â‚™
      â‰¤*-trans (+â‚˜-identityË¡â†’ (ur , sp+r)) (â‰¤*-trans dr br)))
\end{code}

%<*trav>
\begin{code}
    trav : âˆ€ {Î“ Î” A} â†’ [ ğ“¥ ] Î“ â‡’áµ‰ Î” â†’ Î” âŠ¢ A â†’ Î“ âŠ¢ A
    trav Ï (var x) = tm (Ï .lookup (Ï .fit-here) x)
    trav Ï (!-I (âŸ¨ sp* âŸ©Â·á¶œ M)) =
      let sp*â€² , Ïâ€² = env-* (Ï , sp*) in
      !-I (âŸ¨ sp*â€² âŸ©Â·á¶œ (trav Ïâ€² M))
    trav Ï (!-E (M âœ´á¶œâŸ¨ sp+ âŸ© N)) =
      let Ïâ‚— â†˜, sp+â€² ,â†™ Ïáµ£ = env-+ (Ï , sp+) in
      !-E (trav Ïâ‚— M âœ´á¶œâŸ¨ sp+â€² âŸ© trav (bindEnv Ïáµ£) N)
\end{code}
%</trav>

%<*dlv>
\begin{code}
  â†™áµ› : Weakening _âˆ‹_
  â†™áµ› R0 v .idx = â†™ (v .idx)
  â†™áµ› R0 v .tyq = v .tyq
  â†™áµ› R0 v .basis = v .basis ++â‚™ R0
\end{code}
%</dlv>

\begin{code}
  open Kit
\end{code}

%<*var-kit>
\begin{code}
  âˆ‹-kit : Kit _âˆ‹_
  âˆ‹-kit = kit â†™áµ› id var

  ren : âˆ€ {Î“ Î” A} â†’ [ _âˆ‹_ ] Î“ â‡’áµ‰ Î” â†’ Î” âŠ¢ A â†’ Î“ âŠ¢ A
  ren = trav âˆ‹-kit
\end{code}
%</var-kit>

\begin{code}
  instance
    identityEnv-âŠ¢ : IdentityEnv _âŠ¢_
    identityEnv-âŠ¢ .pure = var
\end{code}

%<*dlv-env>
\begin{code}
  â†™^Env : {ğ“¥ : Ctx â†’ Ty â†’ Set} â†’ Weakening ğ“¥ â†’ Weakening [ ğ“¥ ]_â‡’áµ‰_
  â†™^Env â†™^ğ“¥ R0 Ï .Î¨ = [ Ï .Î¨ â”‚ 0á´¿ ]á´¿
  â†™^Env â†™^ğ“¥ R0 Ï .fit-here = Ï .fit-here , â‰¤*â†’0* R0
  â†™^Env â†™^ğ“¥ R0 Ï .lookup (r , sp0) v = â†™^ğ“¥ (0*â†’â‰¤* sp0) (Ï .lookup r v)

  â†™áµ›-env :
    âˆ€ {s t P} {Î³ : Vector Ty (s <+> t)} â†’ P âˆ˜ â†˜ â‰¤* 0* â†’
    [ _âˆ‹_ ] ctx P Î³ â‡’áµ‰ ctx (P âˆ˜ â†™) (Î³ âˆ˜ â†™)
  â†™áµ›-env R0 = â†™^Env â†™áµ› R0 id^Env
\end{code}
%</dlv-env>

%<*sub>
\begin{code}
  âŠ¢-kit : Kit _âŠ¢_
  âŠ¢-kit = kit (Î» R0 â†’ ren (â†™áµ›-env R0)) var id

  sub : âˆ€ {Î“ Î” A} â†’ [ _âŠ¢_ ] Î“ â‡’áµ‰ Î” â†’ Î” âŠ¢ A â†’ Î“ âŠ¢ A
  sub = trav âŠ¢-kit
\end{code}
%</sub>

\begin{code}
  idË¢ : âˆ€ {Î“} â†’ [ _âŠ¢_ ] Î“ â‡’áµ‰ Î“
  idË¢ = id^Env

  psh-âŠ¢ : IsPresheaf _âŠ¢_
  psh-âŠ¢ QP = ren (subuse^Env QP)

  mutual
    open With-psh^ğ“¥ psh-âŠ¢
\end{code}

%<*subSingle>
\begin{code}
    sub[-] : âˆ€ {s P Q R Î³ r A B} â†’ R â‰¤[ Q +*_] â—‡ _â‰¤[ r *â‚— P ] â†’
      ctx {s} P Î³ âŠ¢ A â†’ ctx Q Î³ ++á¶œ [ r âˆ™ A ]á¶œ âŠ¢ B â†’ ctx R Î³ âŠ¢ B
    sub[-] {Q = Q} {R} {Î³} {r} {A} (sp+ , sp*) t = sub Ïƒ
      where
      Ïƒ : [ _âŠ¢_ ] ctx R Î³ â‡’áµ‰ ctx Q Î³ ++á¶œ [ r âˆ™ A ]á¶œ
      Ïƒ = ++áµ‰ (id^Env âœ´á¶œâŸ¨ sp+ âŸ© [-]áµ‰ (âŸ¨ sp* âŸ©Â·á¶œ t))
\end{code}
%</subSingle>
